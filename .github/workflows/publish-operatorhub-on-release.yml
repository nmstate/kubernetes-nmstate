name: Publish to OperatorHub on Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish (e.g., v0.88.0)'
        required: true
        type: string
      community_operators_midstream_repo_org:
        description: 'Midstream repostiory for opening a PR'
        required: true
        type: choice
        default: 'openshift-networking'
        options:
          - openshift-networking

env:
  OPERATOR_NAME: kubernetes-nmstate-operator
  IMAGE_REGISTRY: quay.io
  IMAGE_REPO: nmstate
  HANDLER_IMAGE_NAME: kubernetes-nmstate-handler
  OPERATOR_IMAGE_NAME: kubernetes-nmstate-operator

jobs:
  publish-to-community-operators:
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.event.inputs.tag }}"
          fi

          # Remove 'v' prefix if present
          VERSION="${TAG#v}"

          # Validate semver format
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in semver format (e.g., 0.88.0)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Checkout kubernetes-nmstate
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.tag }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Generate bundle
        run: |
          make bundle VERSION=${{ steps.version.outputs.version }} \
            HANDLER_IMAGE_TAG=${{ steps.version.outputs.tag }} \
            OPERATOR_IMAGE_TAG=${{ steps.version.outputs.tag }} \
            HANDLER_PULL_POLICY=IfNotPresent \
            OPERATOR_PULL_POLICY=IfNotPresent

      - name: Validate bundle
        run: |
          # Verify bundle was generated correctly
          if [ ! -f "bundle/manifests/${{ env.OPERATOR_NAME }}.clusterserviceversion.yaml" ]; then
            echo "Error: CSV file not found"
            exit 1
          fi

          # Check that images reference the correct version
          if ! grep -q "${{ steps.version.outputs.tag }}" "bundle/manifests/${{ env.OPERATOR_NAME }}.clusterserviceversion.yaml"; then
            echo "Warning: CSV may not reference the correct image tag"
          fi

      - name: Checkout community-operators
        uses: actions/checkout@v4
        with:
          repository: k8s-operatorhub/community-operators
          path: community-operators
          token: ${{ secrets.OPERATORHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "kubernetes-nmstate-bot"
          git config --global user.email "nmstate-bot@users.noreply.github.com"

      - name: Create operator version directory
        run: |
          OPERATOR_DIR="community-operators/operators/${{ env.OPERATOR_NAME }}/${{ steps.version.outputs.version }}"
          mkdir -p "$OPERATOR_DIR"

          # Copy bundle manifests and metadata
          cp -r bundle/manifests "$OPERATOR_DIR/"
          cp -r bundle/metadata "$OPERATOR_DIR/"

          # Copy bundle.Dockerfile if it exists
          if [ -f "bundle.Dockerfile" ]; then
            cp bundle.Dockerfile "$OPERATOR_DIR/"
          fi

      - name: Create and push PR branch
        working-directory: community-operators
        run: |
          BRANCH_NAME="kubernetes-nmstate-${{ steps.version.outputs.version }}"
          git checkout -b "$BRANCH_NAME"
          git add operators/${{ env.OPERATOR_NAME }}/${{ steps.version.outputs.version }}
          git commit -m "operator ${{ env.OPERATOR_NAME }} (${{ steps.version.outputs.version }})"
          git push "https://github.com/${{ github.event.inputs.community_operators_midstream_repo_org }}/community-operators.git" "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request to community-operators
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.OPERATORHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: 'k8s-operatorhub',
              repo: 'community-operators',
              title: 'operator ${{ env.OPERATOR_NAME }} (${{ steps.version.outputs.version }})',
              head: '${{ env.BRANCH_NAME }}',
              base: 'main',
              body: `## kubernetes-nmstate-operator version ${{ steps.version.outputs.version }}

            This PR adds version ${{ steps.version.outputs.version }} of the kubernetes-nmstate-operator to OperatorHub.

            **Release**: ${{ github.event.release.html_url || 'Manual trigger' }}

            ### Images
            - Handler: \`${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.HANDLER_IMAGE_NAME }}:${{ steps.version.outputs.tag }}\`
            - Operator: \`${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.OPERATOR_IMAGE_NAME }}:${{ steps.version.outputs.tag }}\`

            ### Checklist
            - [x] Bundle manifests generated and validated
            - [x] Image tags updated to ${{ steps.version.outputs.tag }}
            - [x] Pull policy set to IfNotPresent
            - [x] Automatically generated from release ${{ steps.version.outputs.tag }}

            /kind operator
            /area provider/kubernetes`
            });

            core.info(\`Community operators PR created: \${pr.html_url}\`);
            return { pr_url: pr.html_url, pr_number: pr.number };

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: operator-bundle-${{ steps.version.outputs.version }}
          path: |
            bundle/
            bundle.Dockerfile
          retention-days: 90

      - name: Create job summary
        run: |
          echo "## OperatorHub Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully published to community-operators" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Handler Image**: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.HANDLER_IMAGE_NAME }}:${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Operator Image**: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.OPERATOR_IMAGE_NAME }}:${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The bundle has been uploaded as an artifact and is available for 90 days." >> $GITHUB_STEP_SUMMARY

  publish-to-community-operators-prod:
    runs-on: ubuntu-latest
    needs: publish-to-community-operators
    # Only run for production releases (not pre-releases)
    if: github.event_name == 'release' && !github.event.release.prerelease
    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in semver format"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Checkout kubernetes-nmstate
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.tag }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Generate bundle
        run: |
          make bundle VERSION=${{ steps.version.outputs.version }} \
            HANDLER_IMAGE_TAG=${{ steps.version.outputs.tag }} \
            OPERATOR_IMAGE_TAG=${{ steps.version.outputs.tag }} \
            HANDLER_PULL_POLICY=IfNotPresent \
            OPERATOR_PULL_POLICY=IfNotPresent

      - name: Checkout community-operators-prod
        uses: actions/checkout@v4
        with:
          repository: redhat-openshift-ecosystem/community-operators-prod
          path: community-operators-prod
          token: ${{ secrets.OPERATORHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "kubernetes-nmstate-bot"
          git config --global user.email "nmstate-bot@users.noreply.github.com"

      - name: Create operator version directory
        run: |
          OPERATOR_DIR="community-operators-prod/operators/${{ env.OPERATOR_NAME }}/${{ steps.version.outputs.version }}"
          mkdir -p "$OPERATOR_DIR"

          cp -r bundle/manifests "$OPERATOR_DIR/"
          cp -r bundle/metadata "$OPERATOR_DIR/"

          if [ -f "bundle.Dockerfile" ]; then
            cp bundle.Dockerfile "$OPERATOR_DIR/"
          fi

      - name: Create and push PR branch
        working-directory: community-operators-prod
        run: |
          BRANCH_NAME="kubernetes-nmstate-${{ steps.version.outputs.version }}"
          git checkout -b "$BRANCH_NAME"
          git add operators/${{ env.OPERATOR_NAME }}/${{ steps.version.outputs.version }}
          git commit -m "operator ${{ env.OPERATOR_NAME }} (${{ steps.version.outputs.version }})"
          git push "https://github.com/${{ github.event.inputs.community_operators_midstream_repo_org }}/community-operators.git" "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request to community-operators-prod
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.OPERATORHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: 'redhat-openshift-ecosystem',
              repo: 'community-operators-prod',
              title: 'operator ${{ env.OPERATOR_NAME }} (${{ steps.version.outputs.version }})',
              head: '${{ env.BRANCH_NAME }}',
              base: 'main',
              body: `## kubernetes-nmstate-operator version ${{ steps.version.outputs.version }}

            This PR adds version ${{ steps.version.outputs.version }} of the kubernetes-nmstate-operator to OpenShift OperatorHub (production).

            **Release**: ${{ github.event.release.html_url }}

            ### Images
            - Handler: \`${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.HANDLER_IMAGE_NAME }}:${{ steps.version.outputs.tag }}\`
            - Operator: \`${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.OPERATOR_IMAGE_NAME }}:${{ steps.version.outputs.tag }}\`

            ### Checklist
            - [x] Bundle manifests generated and validated
            - [x] Image tags updated to ${{ steps.version.outputs.tag }}
            - [x] Production release (not pre-release)
            - [x] Automatically generated from release ${{ steps.version.outputs.tag }}

            /kind operator`
            });

            core.info(\`Community operators prod PR created: \${pr.html_url}\`);

      - name: Update job summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully published to community-operators-prod (OpenShift)" >> $GITHUB_STEP_SUMMARY
